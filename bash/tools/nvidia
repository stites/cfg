#!/usr/bin/env bash

safe_path_add "/usr/local/cuda/bin"

# for NNPack
export CUDADIR=/usr/local/cuda
export ATLASDIR=/usr/lib/x86_64-linux-gnu/atlas
# export ATLASDIR=/usr/include/x86_64-linux-gnu/atlas
export LAPACKDIR=/usr/lib/x86_64-linux-gnu/lapack

if [ -d "/usr/local/cuda/lib64" ]; then
  # for cuda libraries
  export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
fi

if [ -d "/usr/local/cuda/extras/CUPTI/lib64" ]; then
  # for cuda profiling tools
  export LD_LIBRARY_PATH="/usr/local/cuda/extras/CUPTI/lib64:$LD_LIBRARY_PATH"
fi

if [ -d "/usr/local/magma/lib" ]; then
  # for cuda LAPACK
  export LD_LIBRARY_PATH="/usr/local/magma/lib:$LD_LIBRARY_PATH"
fi

if [ -d "/opt/intel/lib" ]; then
  # for cuda LAPACK
  export LD_LIBRARY_PATH="/opt/intel/lib:$LD_LIBRARY_PATH"
  source /opt/intel/compilers_and_libraries/linux/bin/compilervars.sh intel64
fi

function GPULogoOff {
  local GPU_NUM="$1"
  GPU_BRIGHTNESS="$(nvidia-settings --query [gpu:$GPU_NUM]/GPULogoBrightness --terse 2>/dev/null)"
  if $GPU_LIGHTS_OFF && [ "$GPU_BRIGHTNESS" != "0" ] && [ "$GPU_BRIGHTNESS" != "" ]; then
    nvidia-settings --assign [gpu:$GPU_NUM]/GPULogoBrightness=0 1> /dev/null
  fi
}

function nvidia-pids {
  nvidia-smi --query-compute-apps=pid --format=csv | grep -v pid | sort | uniq
}

function nvidia-killall {
  for pid in $(nvidia-pids); do
    kill -15 $pid
  done
}

export -f nvidia-pids
export -f nvidia-killall

if command -v nvidia-settings &> /dev/null && [ -z "$GPU_LIGHTS_ON" ]; then
  GPULogoOff 0
  GPULogoOff 1
  GPULogoOff 2
  GPULogoOff 3
  GPU_LIGHTS_ON=false
fi

